---
id: karma
title: Karma
sidebar_label: Karma
---

Karma
-----

The karma module provides a way to limit Transactions on a user by user case.
One user, called the oracle is given unlimited access, other users are limited 
in the number and timing of transactions by various karma parameters.  

## Installation

To install include the karma contract in the genesis.json file when starting the
chain for the first time.
```json
     {
            "vm": "plugin",
            "format": "plugin",
            "name": "karma",
            "location": "karma:1.0.0",
            "init": {
            }
        },

```
  
## Activation

Activating the karma functionality is done from the loom.yaml configuration file.
* DeployEnabled Toggles the karma module on and off. 
* Oracle: Address for the Oracle. The Oracle is unaffected by karma restrictions. 
An Oracle is compulsory if karma is enabled. 
* SessionDuration: A Time period in seconds, karma restricts users to a configurable
 number of transactions during any interval of `SessionDuration` size.
* SessionMaxAccessCount: Base value used to calculate number of Transaction per `SessionDuration`.
A `SessionMaxAccessCount` of `0` indicates there are no karma based limit on transactions number.

Example loom.yaml fragment.
```yaml
DeployEnabled: true
Oracle:        "default:0xAfaA41C81A316111fB0A4644B7a276c26bEA2C9F"
SessionDuration: 60
SessionMaxAccessCount: 10
```
Normally you will want to 

## Oracle
The Oracle has general override ability for a DAppChain. It is defined in the `loom.yaml` file.

* The Oracle is compulsory is karma is enabled.
* It is unaffected by karma restrictions.
* It is the only user that can successfully call the following karma configuration transactions.
    * `UpdateSourcesForUser`
    * `DeleteSourcesForUser`
    * `UpdateConfigOracleMutability`
    * `UpdateConfigOracle`


Some non-karma but related features of the Oracle include being unaffected by 
`DeployEnabled` and `CallEnabled` `loom.yaml` settings. 
`DeployEnabled: false` disable all deploy transactions on the DAppChain, and `
CallEnabled: false` similarly disabled all call transactions.

## Sources
Karma is generated by sources. Sources could correspond to different user types,
privilege levels, promotions or temporary changes in status.
```go
type KarmaSourceReward struct {
    Name   string
    Reward int64
}
```
`Name`is a descriptive string used to identify a source.
`Reward`is used to multiply karma associated with the source. A high `Reward` value means
 each point of karma generated by the source has more effect than a source with a lower `Reward`.
 
 Sources can be configured in two ways.
 
 #### Sources: Genesis File
 Sources can be set up in the karma init segment of the DAppChain genesis file. 
 This allows sources to be available the first time the DAppChain is run. For example:
 ```json
    {
        "vm": "plugin",
        "format": "plugin",
        "name": "karma",
        "location": "karma:1.0.0",
        "init": {
            "Params": {
                "config": {
                    "sources": [
                        {
                            "name": "sms",
                            "reward": "1"
                        },
                        {
                            "name": "oauth",
                            "reward": "3"
                        },
                        {
                            "name": "token",
                            "reward": "4"
                        }
                    ],
                }
            }
        }
    }
```
This starts the DAppChain with three sources, "sms", "oauth" and "token" with varying reward levels.

#### Soures: UpdateConfig
The karma method `UpdateConfig` is used to reset the karma parameters including the sources
in a running DAppChain. 
Usually you will want to download the existing parameters with `GetConfig` and amend that before
using to set the karma configuration parameters with `UpdateConfig`.
```go
import `github.com/loomnetwork/go-loom/builtin/types/karma`

func AddSource(name string, reward int 64, signer auth.Signer, oracle loom.Addres) {
	// Get the address of the karma contract on the DAppChain
	karmaAddr, err := ResolveAddress("karma")
	contract, err := contract(karmaAddr)
	
	// Get the existing configuration parameters
	var resp karma.KarmaConfig
	_, err = contract.StaticCall("GetConfig", oracle.MarshalPB(), signer, &resp)
	config, err := formatJSON(&resp)
	
	// Add the new source
	var configVal karma.KarmaConfigValidator
	configVal.Oracle = oracle.MarshalPB()
	configVal.Parms.Config = config
	config.Parms.Config.Sources = append(config.Parms.Config.Sources, karma.KarmaSourceReward {
            Name: name,
            Reward: reward,
	})
	
	// Update the source information on the DAppChain
	_, err = contract.Call("UpdateConfig", configVal, signer, nil)
}
```
## Users
If karma has been enabled, each user will be restricted by their karma allocation.
Each user will be associated with zero or more sources. This list may contain both active sources, 
in karma's current list of sources, or inactive sources.  
```go
type KarmaSource struct {
	Name  string
	Count int64 
}

type KarmaAddressSource struct {
	User    *types.Address 
	Sources []*KarmaSource 
}
```
`Name` identifies a source and corresponds to the `Name` field in `KarmaSourceReward` above.
`Count` the number of a particular source associated with the address.
The karma a source provides to an address is `

`KarmaSource.Count*KarmaSourceReward.Reward`

The total amount of karma is the sum of the karma from each active karma source associated with the address.
The sources associated with a user can configured either in the genesis file or by the karma 
methods `UpdateSourcesForUser` and `DeleteSourcesForUser`.

#### Users: Genesis File
Users can be associated with sources in the genesis file. This allows users to have
karma available as soon a new DAppChain starts.  For example:
```json
        {
            "vm": "plugin",
            "format": "plugin",
            "name": "karma",
            "location": "karma:1.0.0",
            "init": {
                "Params": {
                    "config": {
                        "sources": [
                            {
                                "name": "sms",
                                "reward": "1"
                            },
                            {
                                "name": "oauth",
                                "reward": "3"
                            },
                            {
                                "name": "token",
                                "reward": "4"
                            }
                        ],
                    },
                    "users": [
                        {
                            "user": {
                                "chainId": "default",
                                "local": "QjWhaN9qvpdI9MjS1YuL1GukwLc="
                            },
                            "sources": [
                                {
                                    "name": "oauth",
                                    "count": "10"
                                },
                                {
                                    "name": "token",
                                    "count": "3"
                                }
                            ]
                        }
                    ]
                }
            }
        },
```
This genesis file fragment will create three sources and give the user with local address
`QjWhaN9qvpdI9MjS1YuL1GukwLc` 20 rewards from `oauth` and3 rewards from `token`.
This user would than start with `20*10 + 3*4 = 42` karma.

#### Users: UpdateSourcesForUser and DeleteSourcesForUser


#### SessionDuration and SessionMaxAccessCount
If karma is enabled, all users other than the Oracle are restricted depending on the 
karma parameters, `SessionDuration` and `SessionMaxAccessCount`, in the loom.yaml.
Each user is restricted, during any period of `SessionDuration` seconds to a number of transactions
dependant on `SessionMaxAccessCount` and the user's karma.

* A user can only make transactions if they have strictly positive karma.
* A zero `SessionMaxAccessCount` means that only karma based restriction
on transaction usage is that the user must have non-zero karma.
* For strictly positive `SessionMaxAccessCount`
    * Deploy transaction are limited to `SessionMaxAccessCount` per period.
    * Call transaction are limited to `SessionMaxAccessCount + karma` per period. 
    
    

## Karma methods
Varables
ConfigKey
OracleKey
Functions
Meta() (plugin.Meta, error) 
Init(ctx contract.Context, req *InitRequest) error 
GetUserStateKey(owner *types.Address) []byte
GetConfig(ctx contract.StaticContext, ko *types.Address) (*Config, error)
GetState(ctx contract.StaticContext, user *types.Address) (*State, error)
GetTotal(ctx contract.StaticContext, params *types.Address) (*ktypes.KarmaTotal, error)
UpdateSourcesForUser(ctx contract.Context, ksu *ktypes.KarmaStateUser) error
DeleteSourcesForUser(ctx contract.Context, ksu *ktypes.KarmaStateKeyUser) error
UpdateConfig(ctx contract.Context, kpo *ktypes.KarmaConfigValidator) error 
UpdateConfigOracleMutability(ctx contract.Context, params *ktypes.KarmaParamsMutableValidator) error 
UpdateConfigOracle(ctx contract.Context, params *ktypes.KarmaParamsValidatorNewOracle) error  
  
  
  
  
  
  
  
  
  
  
  
 
 
 